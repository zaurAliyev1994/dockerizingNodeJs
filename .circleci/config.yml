#version: 2
#jobs:
#  build:
#    docker:
#    specify the version you desire here
#      - image: circleci/node:7.10
#
#
#    working_directory: ~/repo
#
#    steps:
#      - checkout
#      - run: npm install
#      - setup_remote_docker:
#                docker_layer_caching: true
#      - run:
#          name: Build and push Docker
#          command: |
#                TAG=0.1.$CIRCLE_BUILD_NUM
#                docker build -t zaliyev/node-web-app .
#                docker login -u zaliyev -p 8575833Aa
#                docker push zaliyev/node-web-app

version: 2
jobs:
  build:
    working_directory: ~/repo
    docker:
      - image: circleci/node:7.10
    steps:
     - checkout
     - run: npm install
     - setup_remote_docker:
        docker_layer_caching: true
     - run:
               name: Python version
               command: |
                 sudo apt-get update && apt-get install -y python-pip libpython-dev
                 python -V
     - run:
          name: Install dependencies
          command: |
            sudo pip install awscli

     - run:
          name: Build application Docker image
          command: |
            docker build -t app .
     - deploy:
          name: Push application Docker image
          command: |
            CLUSTER='docker-cluster'
            FAMILY='test-app'
            DOCKER_IMAGE='docker-repo'
            TASK='test-app'
            SERVICE='app-service'
            # Login to AWS
            aws configure set region $AWS_REGION
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            $(aws ecr get-login)
            # Tag and push docker image
            docker tag app $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$DOCKER_IMAGE
            docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$DOCKER_IMAGE